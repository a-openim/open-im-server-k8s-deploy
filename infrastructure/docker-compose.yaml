version: '3.8'

networks:
  openim:
    driver: bridge

services:
  mongo:
    image: mongo:7.0
    container_name: mongo
    # 限制内存以省钱，wiredTigerCacheSizeGB 设为 0.25 (约 256MB)
    command: >
      bash -c '
      docker-entrypoint.sh mongod --wiredTigerCacheSizeGB 0.25 --auth &
      until mongosh -u root -p openIM123 --authenticationDatabase admin --eval "db.runCommand({ ping: 1 })" &>/dev/null; do
        sleep 1
      done &&
      mongosh -u root -p openIM123 --authenticationDatabase admin --eval "
      db = db.getSiblingDB(\"openim_v3\");
      if (!db.getUser(\"openIM\")) {
        db.createUser({
          user: \"openIM\",
          pwd: \"openIM123\",
          roles: [{role: \"readWrite\", db: \"openim_v3\"}]
        });
      }
      " &&
      tail -f /dev/null
      '
    volumes:
      - "./components/mongodb/data/db:/data/db"
    environment:
      - TZ=Asia/Shanghai
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=openIM123
    deploy:
      resources:
        limits:
          memory: 512M
    restart: always
    networks:
      - openim

  redis:
    image: redis:7.0.0
    container_name: openim-redis
    volumes:
      - "./components/redis/data:/data"
    # 增加内存限制和淘汰策略，适合小内存服务器
    command: [
        "redis-server",
        "--requirepass", "openIM123",
        "--maxmemory", "256mb",
        "--maxmemory-policy", "allkeys-lru",
        "--appendonly", "yes"
      ]
    deploy:
      resources:
        limits:
          memory: 384M
    restart: always
    networks:
      - openim

  etcd:
    image: bitnamilegacy/etcd:3.5.13
    container_name: etcd
    ports:
      - "12379:2379"
    environment:
      - ETCD_NAME=s1
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ALLOW_NONE_AUTHENTICATION=no
      - ETCD_ROOT_USER=root
      - ETCD_ROOT_PASSWORD=openIM123
    volumes:
      - "./components/etcd:/etcd-data"
    deploy:
      resources:
        limits:
          memory: 256M
    restart: always
    networks:
      - openim

  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: redpanda
    # 删除了 Zookeeper，内存压低至 512M
    command:
      - redpanda start
      - --overprovisioned
      - --smp 1
      - --memory 512M
      - --reserve-memory 0M
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - openim

  minio:
    image: minio/minio:RELEASE.2024-01-11T07-46-16Z
    container_name: minio
    ports:
      - "10005:9000"
      - "10004:9090"
    volumes:
      - "./components/mnt/data:/data"
    environment:
      MINIO_ROOT_USER: root
      MINIO_ROOT_PASSWORD: openIM123
    deploy:
      resources:
        limits:
          memory: 256M
    restart: always
    command: minio server /data --console-address ':9090'
    networks:
      - openim